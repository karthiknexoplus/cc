{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Report Navigation -->
    <div class="report-nav mb-4">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" onclick="showReport('vehicle-in')">
                <i class="fas fa-sign-in-alt"></i> Vehicle In
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showReport('vehicle-out')">
                <i class="fas fa-sign-out-alt"></i> Vehicle Out
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showReport('overnight')">
                <i class="fas fa-moon"></i> Overnight
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="showReport('summary')">
                <i class="fas fa-chart-pie"></i> Summary
            </button>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="date-filter mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <div class="form-group">
                            <label><i class="far fa-calendar-alt"></i> From Date & Time</label>
                            <input type="datetime-local" id="startDateTime" class="form-control form-control-lg">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label><i class="far fa-calendar-alt"></i> To Date & Time</label>
                            <input type="datetime-local" id="endDateTime" class="form-control form-control-lg">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary btn-lg w-100" onclick="generateReport()">
                                <i class="fas fa-sync-alt"></i> Generate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div id="reportContent">
        <!-- Vehicle In Report -->
        <div id="vehicle-in" class="report-section">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sign-in-alt"></i> Vehicle In Report
                        <span class="badge bg-primary ms-2" id="vehicleInCount">0 records</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportReport('vehicle-in')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="printReport('vehicle-in')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="vehicleInTable">
                            <thead>
                                <tr>
                                    <th>Vehicle Number</th>
                                    <th>Category</th>
                                    <th>Entry Time</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Out Report -->
        <div id="vehicle-out" class="report-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sign-out-alt"></i> Vehicle Out Report
                        <span class="badge bg-primary ms-2" id="vehicleOutCount">0 records</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportReport('vehicle-out')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="printReport('vehicle-out')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="vehicleOutTable">
                            <thead>
                                <tr>
                                    <th>Vehicle Number</th>
                                    <th>Category</th>
                                    <th>Exit Time</th>
                                    <th>Amount</th>
                                    <th>Payment Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overnight Report -->
        <div id="overnight" class="report-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-moon"></i> Overnight Report
                        <span class="badge bg-primary ms-2" id="overnightCount">0 records</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportReport('overnight')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="printReport('overnight')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="overnightTable">
                            <thead>
                                <tr>
                                    <th>Vehicle Number</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Validity Days</th>
                                    <th>Location</th>
                                    <th>Site</th>
                                    <th>Created At</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Report -->
        <div id="summary" class="report-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Summary Report
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportReport('summary')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="printReport('summary')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="icon bg-primary">
                                    <i class="fas fa-rupee-sign"></i>
                                </div>
                                <div class="content">
                                    <h3>â‚¹<span id="totalRevenue">0</span></h3>
                                    <p>Total Revenue</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="icon bg-success">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="content">
                                    <h3><span id="totalVehicles">0</span></h3>
                                    <p>Total Vehicles</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="icon bg-info">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div class="content">
                                    <h3><span id="overnightVehicles">0</span></h3>
                                    <p>Overnight Vehicles</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card">
                                <div class="icon bg-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="content">
                                    <h3><span id="avgStayDuration">0</span> hrs</h3>
                                    <p>Avg Stay Duration</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .report-nav {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .report-nav .btn-group {
        width: 100%;
    }

    .report-nav .btn {
        flex: 1;
        padding: 0.75rem;
        font-size: 1.1rem;
    }

    .report-nav .btn i {
        margin-right: 0.5rem;
    }

    .date-filter .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .date-filter .form-control-lg {
        height: calc(3.5rem + 2px);
        font-size: 1.1rem;
    }

    .date-filter .btn-lg {
        height: calc(3.5rem + 2px);
        font-size: 1.1rem;
    }

    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 1rem;
    }

    .card-header {
        background: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding: 1rem 1.5rem;
    }

    .table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .status-active {
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
    }

    .status-inactive {
        background: #ffebee;
        color: #d32f2f;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
    }

    .summary-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s;
    }

    .summary-card:hover {
        transform: translateY(-5px);
    }

    .summary-card .icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .summary-card .content {
        flex: 1;
    }

    .summary-card h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .summary-card p {
        margin: 0;
        color: #6c757d;
        font-size: 0.875rem;
    }
</style>

<script>
    let currentReportType = 'vehicle-in';

    // Initialize date-time range with current day
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        
        document.getElementById('startDateTime').value = startOfDay.toISOString().slice(0, 16);
        document.getElementById('endDateTime').value = endOfDay.toISOString().slice(0, 16);
        
        // Show vehicle in report by default
        showReport('vehicle-in');
    });

    function showReport(reportType) {
        currentReportType = reportType;
        
        // Update active button
        document.querySelectorAll('.report-nav .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.currentTarget.classList.add('active');

        // Hide all report sections
        document.querySelectorAll('.report-section').forEach(section => {
            section.style.display = 'none';
        });

        // Show selected report section
        document.getElementById(reportType).style.display = 'block';

        // Generate report for the selected type
        generateReport();
    }

    function generateReport() {
        const startDateTime = document.getElementById('startDateTime').value;
        const endDateTime = document.getElementById('endDateTime').value;
        
        switch(currentReportType) {
            case 'vehicle-in':
                fetch(`/api/analytics/vehicle-in?start_date=${startDateTime}&end_date=${endDateTime}`)
                    .then(response => response.json())
                    .then(data => {
                        updateVehicleInTable(data);
                        document.getElementById('vehicleInCount').textContent = `${data.length} records`;
                    });
                break;
                
            case 'vehicle-out':
                fetch(`/api/analytics/vehicle-out?start_date=${startDateTime}&end_date=${endDateTime}`)
                    .then(response => response.json())
                    .then(data => {
                        updateVehicleOutTable(data);
                        document.getElementById('vehicleOutCount').textContent = `${data.length} records`;
                    });
                break;
                
            case 'overnight':
                fetch(`/api/analytics/overnight-passes?start_date=${startDateTime}&end_date=${endDateTime}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.passes) {
                            updateOvernightTable(data.passes);
                            document.getElementById('overnightCount').textContent = `${data.summary.total_passes} records`;
                        }
                    });
                break;
                
            case 'summary':
                fetch(`/api/analytics/summary?start_date=${startDateTime}&end_date=${endDateTime}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('totalRevenue').textContent = data.total_revenue.toFixed(2);
                        document.getElementById('totalVehicles').textContent = data.total_vehicles;
                        document.getElementById('overnightVehicles').textContent = data.overnight_vehicles;
                        document.getElementById('avgStayDuration').textContent = data.avg_stay_duration.toFixed(1);
                    });
                break;
        }
    }

    function updateVehicleInTable(data) {
        const tbody = document.querySelector('#vehicleInTable tbody');
        tbody.innerHTML = '';
        data.forEach(vehicle => {
            tbody.innerHTML += `
                <tr>
                    <td>${vehicle.vehicle_number}</td>
                    <td>${vehicle.category}</td>
                    <td>${new Date(vehicle.entry_time).toLocaleString()}</td>
                    <td>${vehicle.location}</td>
                    <td><span class="status-active">Active</span></td>
                </tr>
            `;
        });
    }

    function updateVehicleOutTable(data) {
        const tbody = document.querySelector('#vehicleOutTable tbody');
        tbody.innerHTML = '';
        data.forEach(vehicle => {
            tbody.innerHTML += `
                <tr>
                    <td>${vehicle.vehicle_number}</td>
                    <td>${vehicle.category}</td>
                    <td>${new Date(vehicle.exit_time).toLocaleString()}</td>
                    <td>â‚¹${vehicle.amount.toFixed(2)}</td>
                    <td><span class="status-active">${vehicle.payment_status}</span></td>
                </tr>
            `;
        });
    }

    function updateOvernightTable(data) {
        const tbody = document.querySelector('#overnightTable tbody');
        tbody.innerHTML = '';
        data.forEach(pass => {
            const createdAt = new Date(pass.created_at).toLocaleString();
            const statusClass = pass.status === 'active' ? 'status-active' : 'status-inactive';
            
            tbody.innerHTML += `
                <tr>
                    <td>${pass.name}</td>
                    <td>${pass.vehicle_category}</td>
                    <td>â‚¹${pass.amount.toFixed(2)}</td>
                    <td>${pass.validity_days} days</td>
                    <td>${pass.location}</td>
                    <td>${pass.site}</td>
                    <td>${createdAt}</td>
                    <td><span class="${statusClass}">${pass.status}</span></td>
                </tr>
            `;
        });
    }

    function exportReport(reportType) {
        const startDateTime = document.getElementById('startDateTime').value;
        const endDateTime = document.getElementById('endDateTime').value;
        
        const link = document.createElement('a');
        link.href = `/api/reports/export?type=${reportType}&start_date=${startDateTime}&end_date=${endDateTime}`;
        link.download = `${reportType}-report.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function printReport(reportType) {
        window.print();
    }
</script>
{% endblock %} 