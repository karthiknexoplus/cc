{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="filter-section">
        <div class="date-filter-container">
            <div class="date-filter-group">
                <label for="from-date">From:</label>
                <input type="datetime-local" id="from-date" name="from-date" value="{{ from_date }}">
            </div>
            <div class="date-filter-group">
                <label for="to-date">To:</label>
                <input type="datetime-local" id="to-date" name="to-date" value="{{ to_date }}">
            </div>
            <div class="date-filter-group">
                <label for="device-id">Device:</label>
                <select id="device-id" name="device-id" class="form-control">
                    <option value="">All Devices</option>
                    {% for device_id in device_ids %}
                    <option value="{{ device_id }}" {% if device_id == selected_device_id %}selected{% endif %}>{{ device_id }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="date-filter-group">
                <label for="site">Site:</label>
                <select id="site" name="site" class="form-control">
                    <option value="">All Sites</option>
                    {% for site in sites %}
                    <option value="{{ site }}" {% if site == selected_site %}selected{% endif %}>{{ site }}</option>
                    {% endfor %}
                </select>
            </div>
            <button class="filter-button" onclick="applyDateFilter()">Apply Filter</button>
            <div class="export-buttons">
                <button class="export-button" onclick="exportDashboardData('all')">
                    <i class="fas fa-download"></i> Export All
                </button>
                <button class="export-button" onclick="exportDashboardData('entries')">
                    <i class="fas fa-download"></i> Export Entries
                </button>
                <button class="export-button" onclick="exportDashboardData('exits')">
                    <i class="fas fa-download"></i> Export Exits
                </button>
                <button class="export-button" onclick="exportDashboardData('active')">
                    <i class="fas fa-download"></i> Export Active
                </button>
                <button class="export-button" onclick="exportDashboardData('overnight')">
                    <i class="fas fa-download"></i> Export Overnight
                </button>
                <button class="export-button" onclick="exportDashboardData('summary')">
                    <i class="fas fa-download"></i> Export Summary
                </button>
            </div>
        </div>
    </div>

    <div class="dashboard-header">
        <h1>Dashboard</h1>
    </div>

    <div class="stats-grid">
        <a href="{{ url_for('entries_detail', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Total Entries Today</span>
                <div class="stat-icon entries">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="stat-value">{{ today_entries }}</div>
            <div class="stat-description">Vehicles entered today</div>
        </a>

        <a href="{{ url_for('active_vehicles_detail', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Active Vehicles</span>
                <div class="stat-icon active">
                    <i class="fas fa-car-side"></i>
                </div>
            </div>
            <div class="stat-value">{{ active_vehicles }}</div>
            <div class="stat-description">Currently in parking</div>
        </a>

        <a href="{{ url_for('revenue_detail', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Today's Revenue</span>
                <div class="stat-icon revenue">
                    <i class="fas fa-rupee-sign"></i>
                </div>
            </div>
            <div class="stat-value">â‚¹{{ today_revenue }}</div>
            <div class="stat-description">Total revenue today</div>
        </a>

        <a href="{{ url_for('overnight_vehicles_detail', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Overnight Vehicles</span>
                <div class="stat-icon overnight">
                    <i class="fas fa-moon"></i>
                </div>
            </div>
            <div class="stat-value">{{ overnight_vehicles }}</div>
            <div class="stat-description">Vehicles staying overnight</div>
        </a>

        <a href="{{ url_for('entries_detail', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Total Exits Today</span>
                <div class="stat-icon total-exits">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>
            <div class="stat-value">{{ today_exits }}</div>
            <div class="stat-description">Vehicles exited today</div>
        </a>

        <a href="{{ url_for('vehicle_type_summary', from_date=from_date, to_date=to_date, device_id=selected_device_id, site=selected_site) }}" class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Vehicle Type Summary</span>
                <div class="stat-icon vehicle-type">
                    <i class="fas fa-truck"></i>
                </div>
            </div>
            <div class="stat-value">{{ vehicle_types|length }}</div>
            <div class="stat-description">Different vehicle types</div>
        </a>
    </div>

    <div class="dashboard-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h2>Vehicle Entry Distribution</h2>
                <div class="chart-actions">
                    <button onclick="exportChart('entryDistributionChart', 'Vehicle Entry Distribution')" class="export-btn">
                        <i class="fas fa-download"></i> Export Chart
                    </button>
                    <button onclick="exportData('entry_data', 'Vehicle Entry Distribution')" class="export-btn">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="entryDistributionChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h2>Revenue by Payment Method</h2>
                <div class="chart-actions">
                    <button onclick="exportChart('paymentMethodChart', 'Revenue by Payment Method')" class="export-btn">
                        <i class="fas fa-download"></i> Export Chart
                    </button>
                    <button onclick="exportData('payment_data', 'Revenue by Payment Method')" class="export-btn">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="paymentMethodChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h2>Vehicle Type Distribution</h2>
                <div class="chart-actions">
                    <button onclick="exportChart('vehicleTypeChart', 'Vehicle Type Distribution')" class="export-btn">
                        <i class="fas fa-download"></i> Export Chart
                    </button>
                    <button onclick="exportData('vehicle_data', 'Vehicle Type Distribution')" class="export-btn">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="vehicleTypeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h2>Hourly Revenue Trend</h2>
                <div class="chart-actions">
                    <button onclick="exportChart('revenueTrendChart', 'Hourly Revenue Trend')" class="export-btn">
                        <i class="fas fa-download"></i> Export Chart
                    </button>
                    <button onclick="exportData('revenue_data', 'Hourly Revenue Trend')" class="export-btn">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="revenueTrendChart"></canvas>
            </div>
        </div>

        <div class="recent-entries">
            <div class="chart-header">
                <h2>Recent Entries</h2>
                <div class="chart-actions">
                    <button onclick="exportData('recent_entries', 'Recent Entries')" class="export-btn">
                        <i class="fas fa-file-csv"></i> Export Data
                    </button>
                </div>
            </div>
            <ul class="entry-list">
                {% for entry in recent_entries %}
                <li class="entry-item">
                    <div class="entry-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="entry-content">
                        <div class="entry-title">{{ entry.vehicle_number }}</div>
                        <div class="entry-details">
                            <span>{{ entry.vehicle_type }}</span>
                            <span>{{ entry.location }}</span>
                        </div>
                    </div>
                    <div class="entry-time">{{ entry.entry_time }}</div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    display: block;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.stat-title {
    color: #666;
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.stat-icon.entries {
    background: rgba(33, 150, 243, 0.1);
    color: #2196f3;
}

.stat-icon.active {
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.stat-icon.revenue {
    background: rgba(255, 152, 0, 0.1);
    color: #ff9800;
}

.stat-icon.overnight {
    background: rgba(156, 39, 176, 0.1);
    color: #9c27b0;
}

.stat-icon.total-exits {
    background: rgba(233, 30, 99, 0.1);
    color: #e91e63;
}

.stat-icon.vehicle-type {
    background: rgba(156, 39, 176, 0.1);
    color: #9c27b0;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.stat-description {
    color: #666;
    font-size: 0.85rem;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    height: 300px;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-header h2 {
    color: #333;
    font-size: 1.2rem;
    font-weight: 600;
}

.chart-container {
    height: 250px;
    position: relative;
}

.recent-entries {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.entry-list {
    list-style: none;
}

.entry-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
}

.entry-item:last-child {
    border-bottom: none;
}

.entry-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    background: rgba(33, 150, 243, 0.1);
    color: #2196f3;
}

.entry-content {
    flex: 1;
}

.entry-title {
    color: #333;
    font-weight: 500;
    margin-bottom: 3px;
}

.entry-details {
    color: #666;
    font-size: 0.8rem;
    display: flex;
    gap: 15px;
}

.entry-time {
    color: #666;
    font-size: 0.8rem;
}

.date-filter-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    align-items: center;
}

.date-filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-filter-group label {
    color: #666;
    font-size: 0.9rem;
    font-weight: 500;
}

.date-filter-group input,
.date-filter-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #333;
}

.date-filter-group input:focus,
.date-filter-group select:focus {
    outline: none;
    border-color: #2196f3;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
}

.filter-button {
    background: #2196f3;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.filter-button:hover {
    background: #1976d2;
}

@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .date-filter-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .date-filter-group {
        width: 100%;
    }
    
    .date-filter-group input,
    .date-filter-group select {
        width: 100%;
    }
}

.chart-actions {
    display: flex;
    gap: 10px;
}

.export-btn {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.8rem;
    color: #666;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
}

.export-btn:hover {
    background: #e9ecef;
    border-color: #ced4da;
}

.export-btn i {
    font-size: 0.9rem;
}

.export-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.export-button {
    padding: 8px 16px;
    background-color: #1a237e;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.export-button:hover {
    background-color: #0d1a6b;
}

.export-button i {
    font-size: 14px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
function applyDateFilter() {
    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const deviceId = document.getElementById('device-id').value;
    const site = document.getElementById('site').value;
    
    // Add the filter parameters to the current URL
    const url = new URL(window.location.href);
    url.searchParams.set('from_date', fromDate);
    url.searchParams.set('to_date', toDate);
    url.searchParams.set('device_id', deviceId);
    url.searchParams.set('site', site);
    
    // Reload the page with the new parameters
    window.location.href = url.toString();
}

function exportChart(chartId, title) {
    const canvas = document.getElementById(chartId);
    const link = document.createElement('a');
    link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function exportData(dataType, title) {
    let data = [];
    let headers = [];
    
    switch(dataType) {
        case 'entry_data':
            headers = ['Hour', 'Entries'];
            data = {{ entry_hours|tojson }}.map((hour, index) => ({
                'Hour': hour,
                'Entries': {{ entry_counts|tojson }}[index]
            }));
            break;
            
        case 'payment_data':
            headers = ['Payment Method', 'Amount'];
            data = {{ payment_methods|tojson }}.map((method, index) => ({
                'Payment Method': method,
                'Amount': {{ payment_amounts|tojson }}[index]
            }));
            break;
            
        case 'vehicle_data':
            headers = ['Vehicle Type', 'Count'];
            data = {{ vehicle_types|tojson }}.map((type, index) => ({
                'Vehicle Type': type,
                'Count': {{ vehicle_type_counts|tojson }}[index]
            }));
            break;
            
        case 'revenue_data':
            headers = ['Hour', 'Revenue'];
            data = {{ entry_hours|tojson }}.map((hour, index) => ({
                'Hour': hour,
                'Revenue': {{ hourly_revenue|tojson }}[index]
            }));
            break;
            
        case 'recent_entries':
            headers = ['Vehicle Number', 'Vehicle Type', 'Entry Time', 'Location'];
            data = {{ recent_entries|tojson }}.map(entry => ({
                'Vehicle Number': entry.vehicle_number,
                'Vehicle Type': entry.vehicle_type,
                'Entry Time': entry.entry_time,
                'Location': entry.location
            }));
            break;
    }
    
    // Convert to CSV
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => row[header]).join(','))
    ].join('\n');
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function exportDashboardData(type) {
    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const deviceId = document.getElementById('device-id').value;
    const site = document.getElementById('site').value;
    
    const url = `/api/dashboard/export?from_date=${fromDate}&to_date=${toDate}&device_id=${deviceId}&site=${site}&type=${type}`;
    window.location.href = url;
}

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates if not provided
    const fromDateInput = document.getElementById('from-date');
    const toDateInput = document.getElementById('to-date');
    
    if (!fromDateInput.value) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        fromDateInput.value = today.toISOString().slice(0, 16);
    }
    
    if (!toDateInput.value) {
        const now = new Date();
        toDateInput.value = now.toISOString().slice(0, 16);
    }

    // Vehicle Entry Distribution Chart
    const entryCtx = document.getElementById('entryDistributionChart').getContext('2d');
    new Chart(entryCtx, {
        type: 'line',
        data: {
            labels: {{ entry_hours|tojson }},
            datasets: [{
                label: 'Vehicle Entries',
                data: {{ entry_counts|tojson }},
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Revenue by Payment Method Chart
    const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
    new Chart(paymentCtx, {
        type: 'pie',
        data: {
            labels: {{ payment_methods|tojson }},
            datasets: [{
                data: {{ payment_amounts|tojson }},
                backgroundColor: [
                    'rgba(33, 150, 243, 0.8)',
                    'rgba(76, 175, 80, 0.8)',
                    'rgba(255, 152, 0, 0.8)',
                    'rgba(156, 39, 176, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    // Vehicle Type Distribution Chart
    const vehicleCtx = document.getElementById('vehicleTypeChart').getContext('2d');
    new Chart(vehicleCtx, {
        type: 'bar',
        data: {
            labels: {{ vehicle_types|tojson }},
            datasets: [{
                label: 'Number of Vehicles',
                data: {{ vehicle_type_counts|tojson }},
                backgroundColor: 'rgba(33, 150, 243, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Hourly Revenue Trend Chart
    const revenueCtx = document.getElementById('revenueTrendChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ entry_hours|tojson }},
            datasets: [{
                label: 'Revenue',
                data: {{ hourly_revenue|tojson }},
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});
</script>
{% endblock %} 